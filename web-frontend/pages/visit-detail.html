<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Detalle de Visita</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="../css/styles.css" rel="stylesheet">
  <style>#map { height: 400px; }</style>

  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TQLZHRQRF8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TQLZHRQRF8');
</script>

</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Visitas</a>
    <div class="d-flex">
      <button id="btnBack" class="btn btn-outline-secondary me-2">Volver</button>
      <button id="btnLogout" class="btn btn-danger">Cerrar sesión</button>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <h4>Detalle de Visita</h4>
  <div id="alert-placeholder"></div>

  <div class="card mb-3">
    <div class="card-body">
      <p><strong>ID:</strong> <span id="vId"></span></p>
      <p><strong>Cliente:</strong> <span id="vClient"></span></p>
      <p><strong>Técnico:</strong> <span id="vTech"></span></p>
      <p><strong>Supervisor:</strong> <span id="vSupervisor"></span></p>
      <p><strong>Programada:</strong> <span id="vScheduled"></span></p>
      <p><strong>Ingreso:</strong> <span id="vCheckIn"></span></p>
      <p><strong>Egreso:</strong> <span id="vCheckOut"></span></p>
      <p><strong>Notas:</strong> <span id="vNotes"></span></p>
      <div class="mb-2">
        <button id="btnCheckIn" class="btn btn-success">Registrar ingreso</button>
        <button id="btnCheckOut" class="btn btn-warning">Registrar egreso</button>
        <button id="btnFinish" class="btn btn-primary">Finalizar y enviar informe</button>
        <button id="btnDownload" class="btn btn-secondary">Descargar PDF</button>
        <a id="linkDirections" class="btn btn-info text-white" target="_blank">Cómo llegar</a>
      </div>
    </div>
  </div>

  <div id="map" class="mb-4 border"></div>
</div>

<script src="../js/app.js"></script>
<script src="../js/api.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
  // Requerir autenticación
  if (!sessionStorage.getItem('jwt')) { window.location = '../index.html'; return; }

  const params = new URLSearchParams(window.location.search);
  const id = params.get('id');
  if (!id) {
    // Si no hay ID, redirigir a la lista de visitas.
    window.showAlert('ID de visita faltante.', 'danger'); 
    window.location='visits.html';
    return;
  }

  const el = {
    vId: document.getElementById('vId'),
    vClient: document.getElementById('vClient'),
    vTech: document.getElementById('vTech'),
    vSupervisor: document.getElementById('vSupervisor'), 
    vScheduled: document.getElementById('vScheduled'),
    vCheckIn: document.getElementById('vCheckIn'),
    vCheckOut: document.getElementById('vCheckOut'),
    vNotes: document.getElementById('vNotes'),
    alert: document.getElementById('alert-placeholder'),
    btnCheckIn: document.getElementById('btnCheckIn'),
    btnCheckOut: document.getElementById('btnCheckOut'),
    btnFinish: document.getElementById('btnFinish'),
    btnDownload: document.getElementById('btnDownload'),
    linkDirections: document.getElementById('linkDirections')
  };

  document.getElementById('btnBack').addEventListener('click', ()=> window.location='visits.html');

  let visitData = null;
  let map, marker; 

  async function load() {
    try {
      visitData = await apiGet('/visits/' + id);
      render();
      initMap(); 
    } catch (e) { window.showAlert(e.message || e,'danger'); } 
  }

  function render(){
    el.vId.innerText = visitData.id;
    el.vClient.innerText = window.escapeHtml(visitData.client?.name || 'N/A');
    el.vTech.innerText = window.escapeHtml(visitData.technician?.username || 'N/A');
    el.vSupervisor.innerText = window.escapeHtml(visitData.supervisor?.username || 'N/A'); 
    
    el.vScheduled.innerText = visitData.scheduledAt ? visitData.scheduledAt.replace('T',' ') : '';
    el.vCheckIn.innerText = visitData.checkIn ? visitData.checkIn.replace('T',' ') : '-';
    el.vCheckOut.innerText = visitData.checkOut ? visitData.checkOut.replace('T',' ') : '-';
    el.vNotes.innerText = visitData.notes || '';
    
    const lat = visitData.checkOutLat || visitData.checkInLat || visitData.client?.latitude;
    const lng = visitData.checkOutLng || visitData.checkInLng || visitData.client?.longitude;
    
    if (lat && lng) {
      el.linkDirections.href = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
      el.linkDirections.style.display = 'inline-block';
    } else {
      el.linkDirections.style.display = 'none';
    }
  }

  async function registerCheck(kind){
    if (!confirm((kind==='in'?'Registrar ingreso':'Registrar egreso') + '?')) return;
    try {
      const partialPayload = {}; 
      const coords = await getCurrentCoords();
      
      if (kind==='in') {
        partialPayload.checkIn = new Date().toISOString();
        if (coords) { partialPayload.checkInLat = coords.lat; partialPayload.checkInLng = coords.lng; }
      } else { 
        partialPayload.checkOut = new Date().toISOString();
        if (coords) { partialPayload.checkOutLat = coords.lat; partialPayload.checkOutLng = coords.lng; }
      }
      
      const result = await apiPut('/visits/' + id, partialPayload);
      window.showAlert(kind==='in' ? 'Ingreso registrado':'Egreso registrado','success'); 
      await load(); 
    } catch (e){ window.showAlert(e.message,'danger'); } 
  }

  el.btnCheckIn.addEventListener('click', ()=> registerCheck('in'));
  el.btnCheckOut.addEventListener('click', ()=> registerCheck('out'));

  el.btnFinish.addEventListener('click', async ()=> {
    if (!confirm('Finalizar visita y enviar informe?')) return;
    try {

      let email = visitData.client?.email || prompt('Email del cliente para enviar el informe:');
      if (!email) { window.showAlert('Email requerido para enviar el informe','danger'); return; } 
      const result = await apiPost(`/visits/${id}/finish`, { email });
      window.showAlert(result.message,'success'); 
      await load(); 
    } catch (e) { window.showAlert(e.message,'danger'); } 
  });

  el.btnDownload.addEventListener('click', async ()=> {
    try {
      const token = sessionStorage.getItem('jwt');
      const res = await fetch((window.__env.API_BASE_URL || 'http://localhost:8081') + `/visits/${id}/report`, {
        method: 'GET',
        headers: { 'Authorization': token ? ('Bearer ' + token) : '' }
      });
      if (!res.ok) { throw new Error('Error al descargar el PDF'); }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `visita_${id}.pdf`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } catch (e) { window.showAlert(e.message,'danger'); } 
  });

  function getCurrentCoords(){
    return new Promise((resolve)=> {
      if (!navigator.geolocation) return resolve(null);
      navigator.geolocation.getCurrentPosition(pos=>{
        resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude });
      }, ()=> resolve(null), { timeout: 8000 });
    });
  }

  async function initMap(){
    const mapDiv = document.getElementById('map');
    mapDiv.innerHTML = '<div class="p-3 text-muted">Cargando mapa...</div>';

    try {

      const key = await window.getGoogleMapsApiKey();
      if (!key) {
        mapDiv.innerHTML = '<div class="p-3 text-muted">ERROR: No se pudo obtener la API Key de Google Maps. Verifica la configuración.</div>';
        return;
      }

      
      const lat = visitData.checkOutLat || visitData.checkInLat || visitData.client?.latitude || 14.5586; // Latitud por defecto (Guatemala)
      const lng = visitData.checkOutLng || visitData.checkInLng || visitData.client?.longitude || -90.7336; // Longitud por defecto (Guatemala)

      if (typeof window.google === 'undefined' || !window.google.maps) {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${key}`;
        script.onload = ()=> createMap(lat,lng);
        script.onerror = () => {
            mapDiv.innerHTML = '<div class="p-3 text-muted">ERROR: No se pudo cargar el script de Google Maps. Verifica tu conexión o la API Key.</div>';
        };
        document.head.appendChild(script);
      } else {
        createMap(lat,lng);
      }
    } catch (error) {
      console.error("Fallo al obtener la API Key o cargar el mapa:", error);
      mapDiv.innerHTML = '<div class="p-3 text-muted">ERROR al cargar el mapa. Verifica la consola y la configuración de la API Key.</div>';
    }
  }

  function createMap(lat,lng){
    const center = { lat: parseFloat(lat), lng: parseFloat(lng) };
    map = new google.maps.Map(document.getElementById('map'), { center, zoom: 15 });
    marker = new google.maps.Marker({ position: center, map: map });
  }

  load();
})();
</script>
</body>
</html>
