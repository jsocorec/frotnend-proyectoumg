<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Configuraciones del Sistema - Visitas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="../css/styles.css" rel="stylesheet">
  <style>

  </style>

  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TQLZHRQRF8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TQLZHRQRF8');
</script>

</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Admin - Configuraciones</a>
    <div class="d-flex">
      <button id="btnDashboard" class="btn btn-outline-secondary me-2">Dashboard</button>
      <button id="btnClients" class="btn btn-outline-secondary me-2">Clientes</button>
      <button id="btnUsers" class="btn btn-outline-secondary me-2">Usuarios</button>
      <button id="btnSettings" class="btn btn-primary me-2">Configuraciones</button> 
      <button id="btnLogout" class="btn btn-danger">Cerrar sesión</button>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Configuraciones del Sistema</h4>
    <button id="btnNewSetting" class="btn btn-primary">Nueva Configuración</button>
  </div>

  <div id="alert-placeholder"></div>

  <table class="table table-striped" id="settingsTable">
    <thead>
      <tr><th>ID</th><th>Clave</th><th>Valor</th><th>Descripción</th><th>Acciones</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Modal (crear/editar configuración) -->
<div class="modal fade" id="settingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="settingForm">
        <div class="modal-header">
          <h5 class="modal-title" id="settingModalTitle">Configuración</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="settingId">
          <div class="mb-3">
            <label class="form-label">Clave</label>
            <input id="settingKey" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Valor</label>
            <input id="settingValue" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Descripción</label>
            <textarea id="settingDescription" class="form-control" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="../js/app.js"></script>
<script src="../js/api.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>

  (function(){

    if (!sessionStorage.getItem('jwt')) { window.location = '../index.html'; return; }

    const tableBody = document.querySelector('#settingsTable tbody');
    const alertPlace = document.getElementById('alert-placeholder');
    const settingModalEl = document.getElementById('settingModal');
    const bsModal = new bootstrap.Modal(settingModalEl);

    document.getElementById('btnLogout').addEventListener('click', ()=> { sessionStorage.clear(); window.location='../index.html'; });
    document.getElementById('btnDashboard').addEventListener('click', ()=> window.location='dashboard.html');
    document.getElementById('btnClients').addEventListener('click', ()=> window.location='clients.html');
    document.getElementById('btnUsers').addEventListener('click', ()=> window.location='admin-users.html');
    document.getElementById('btnNewSetting').addEventListener('click', ()=> openModal());

    async function loadSettings(){
      try {
        const settings = await apiGet('/admin/settings'); 
        renderTable(settings);
      } catch (e) {
        showAlert(`Error cargando configuraciones: ${e.message}`, 'danger');
      }
    }

    function renderTable(settings){
      tableBody.innerHTML = settings.map(s=>`
        <tr>
          <td>${s.id}</td>
          <td>${escapeHtml(s.settingKey||'')}</td>
          <td>${escapeHtml(s.settingValue||'')}</td>
          <td>${escapeHtml(s.description||'')}</td>
          <td>
            <button class="btn btn-sm btn-primary btn-edit" data-id="${s.id}">Editar</button>
            <button class="btn btn-sm btn-danger btn-delete" data-id="${s.id}">Borrar</button>
          </td>
        </tr>
      `).join('');
      document.querySelectorAll('.btn-edit').forEach(b=> b.addEventListener('click', e=> editSetting(e.target.dataset.id)));
      document.querySelectorAll('.btn-delete').forEach(b=> b.addEventListener('click', e=> deleteSetting(e.target.dataset.id)));
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    async function deleteSetting(id){
      if (!confirm('Borrar configuración ID ' + id + '?')) return;
      try {
        await apiDelete('/admin/settings/' + id);
        showAlert('Configuración borrada','success');
        loadSettings();
      } catch (e) { showAlert(`Error borrando configuración: ${e.message}`,'danger'); }
    }

    async function editSetting(id){
      try {
        const s = await apiGet('/admin/settings/' + id);
        openModal(s);
      } catch (e) { showAlert(`Error cargando configuración: ${e.message}`,'danger'); }
    }

    function openModal(setting){
      document.getElementById('settingId').value = setting?.id || '';
      document.getElementById('settingKey').value = setting?.settingKey || '';
      document.getElementById('settingValue').value = setting?.settingValue || '';
      document.getElementById('settingDescription').value = setting?.description || '';
      document.getElementById('settingModalTitle').innerText = setting ? 'Editar Configuración' : 'Nueva Configuración';
      bsModal.show();
    }

    document.getElementById('settingForm').addEventListener('submit', async (evt)=>{
      evt.preventDefault();
      const id = document.getElementById('settingId').value;
      const payload = {
        settingKey: document.getElementById('settingKey').value,
        settingValue: document.getElementById('settingValue').value,
        description: document.getElementById('settingDescription').value
      };
      try {
        if (id) {
          await apiPut('/admin/settings/' + id, payload);
          showAlert('Configuración actualizada','success');
        } else {
          await apiPost('/admin/settings', payload);
          showAlert('Configuración creada','success');
        }
        bsModal.hide();
        loadSettings();
      } catch (e) {
        showAlert(`Error guardando configuración: ${e.message}`,'danger');
      }
    });

    function showAlert(msg,type='info'){
      alertPlace.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${escapeHtml(msg)}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`;
      setTimeout(()=> alertPlace.innerHTML='',4000); 
    }

    loadSettings();
  })();
</script>
</body>
</html>
